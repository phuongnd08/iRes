highlightedOrderLI = null

unhighlightOrder = (li) ->
  $(li).attr('style', '')

highlightOrderLI = (li) ->
  unhighlightOrder(highlightedOrderLI) if highlightedOrderLI
  $(li).attr('style', 'border: 2px solid yellow')
  highlightedOrderLI = li

$(document).delegate '#navigator_page', "pagecreate", ->
    ordersChannel = <%= Order.channel.to_json %>
    formatListItem(li) for li in $('#orders li[data-order-id]')
    if window.Faye && Faye.Client
      orderLI = (order)->
        $('#orders').find('[data-order-id=' + order.order_id + ']')

      pubsubClient = new Faye.Client(<%= ServicesSettings.pubsub.mount_point.to_json %>)
      pubsubClient.subscribe ordersChannel, (order) ->
        if order.deleted
          orderLI(order).fadeOut('slow', ->
            $(this).remove()
          )
        else
          if order.updated
            $.toast order.order_name, I18n.t("states.ready") if order.ready
            orderLI(order).replaceWith(orderTemplate.gsub order)
          if order.created
            $(orderTemplate.gsub order).appendTo('#orders')
          $('#orders').listview('refresh')
          formatListItem orderLI(order)
          highlightOrderLI orderLI(order)
          orderLI(order).fadeOut('fast').fadeIn('slow')

$(document).delegate "#order_page", "pagecreate", ->
  showPage = (selector) ->
    $(".subpage").hide()
    $(selector).show()
    $("#order_page [data-role=navbar] li a").setHeaderInactive()
    $("#order_page [data-nav-to=\"" + selector + "}\"] li a").setHeaderActive()

  $("#order_page [data-role=navbar] li a").click (event) ->
    event.preventDefault()
    showPage $(this).attr("data-nav-to")

  $("#ordering .item").click (event) ->
    event.preventDefault()
    item_id = $(this).attr("data-item-id")
    item_name = $(this).find('a .name').text()
    item_price = $(this).attr("data-item-price")
    Waiter.addItem item_id, item_name, item_price

  $('#ordered').on 'click', '.remove', ->
    Waiter.removeItem $(this).closest('li')

  $("#commit_btn").click (event) ->
    event.preventDefault()
    Waiter.commitOrder this
