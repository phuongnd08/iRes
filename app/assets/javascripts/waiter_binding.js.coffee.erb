formatOrderLI = (li)->
  $(li).find('.ui-li-count').addClass 'ui-btn-up-' + $(li).attr('data-count-theme')

$(document).delegate '#navigator_page', "pagecreate", ->
    ordersChannel = <%= Order.channel.to_json %>
    formatOrderLI(li) for li in $('#orders li[data-order-id]')
    if window.Faye && Faye.Client
      orderLI = (order)->
        $('#orders').find('[data-order-id=' + order.order_id + ']')

      pubsubClient = new Faye.Client(<%= ServicesSettings.pubsub.mount_point.to_json %>)
      pubsubClient.subscribe ordersChannel, (order) ->
        if order.deleted
          orderLI(order).remove()
        else
          li = null
          if order.changed
            $.toast order.order_name, I18n.t("order.ready") if order.ready
            li = orderLI(order).replaceWith(orderTemplate.gsub order)
          if order.created
            li = $(orderTemplate.gsub order).appendTo('#orders')
          $('#orders').listview('refresh')
          formatOrderLI orderLI(order)

$(document).delegate "#order_page", "pagecreate", ->
  showPage = (selector) ->
    $(".subpage").hide()
    $(selector).show()
    $("#order_page [data-role=navbar] li a").setHeaderInactive()
    $("#order_page [data-nav-to=\"" + selector + "}\"] li a").setHeaderActive()

  $("#order_page [data-role=navbar] li a").click (event) ->
    event.preventDefault()
    showPage $(this).attr("data-nav-to")

  $("#ordering .item").click (event) ->
    event.preventDefault()
    item_id = $(this).attr("data-item-id")
    item_name = $(this).find('a .name').text()
    item_price = $(this).attr("data-item-price")
    Waiter.addItem item_id, item_name, item_price

  $('#ordered').on 'click', '.remove', ->
    Waiter.removeItem $(this).closest('li')

  $("#commit_btn").click (event) ->
    event.preventDefault()
    Waiter.commitOrder this
