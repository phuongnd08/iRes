$(document).delegate "#chef_orders_page", "pagecreate", ->
  orderItemsChannel = <%= OrderItem.channel.to_json %>
  ordersChannel = <%= Order.channel.to_json %>
  pubsubClient = new Faye.Client("<%= ServicesSettings.pubsub.mount_point %>")
  backlog = {}

  $(li).formatListItem() for li in $('#chef_orders_page ul.order_items li[data-order-item-id]')

  orderUL = (orderId) ->
    $("#chef_orders_page ul.order_items[data-order-id=" + orderId + "]")
  orderHeaderLI = (orderId) ->
    orderUL(orderId).find('[role=heading]')

  processOrder = (order) ->
    if order.deleted
      orderUL(order.order_id).fadeOutAndRemove()
    else
      if order.created && !order.ready
        $(chefOrderTemplate.gsub(order)).appendTo("#chef_orders_page").listview().blinkAndShow()
        if (backlog[order.order_id])
          processOrderItem orderItem for orderItem in backlog[order.order_id]
      else
        if order.updated
          if order.ready
            orderUL(order.order_id).fadeOutAndRemove()
          else
            if orderUL(order.order_id).exists()
              orderHeaderLI(order.order_id).replaceWith(chefOrderHeaderTemplate.gsub(order))
            else
              $(chefOrderTemplate.gsub(order)).appendTo("#chef_orders_page").listview().blinkAndShow()
              addOrderItem(orderItem) for orderItem in order.order_items
            orderUL(order.order_id).listview('refresh').blinkAndShow()
            $(li).formatListItem() for li in orderUL(order.order_id).find('li[data-order-item-id]')

  pubsubClient.subscribe ordersChannel, processOrder

  orderItemLI = (orderItem) ->
    $("#chef_orders_page ul.order_items").find("[data-order-item-id=" + orderItem.order_item_id + "]")

  addOrderItem = (orderItem) ->
    orderItemLIHtml = chefOrderItemTemplate.gsub(orderItem)
    orderUL(orderItem.order_id).append(orderItemLIHtml)

  processOrderItem = (orderItem) ->
    if orderItem.deleted
      orderItemLI(orderItem).remove()
    else
      ul = orderUL(orderItem.order_id)
      if ul.exists()
        if orderItem.created
          addOrderItem(orderItem)
        else
          if orderItem.updated
            orderItemLIHtml = chefOrderItemTemplate.gsub(orderItem)
            orderItemLI(orderItem).replaceWith(orderItemLIHtml)
        ul.listview "refresh"
        orderItemLI(orderItem).formatListItem()
      else
        backlog[orderItem.order_id] ||= []
        backlog[orderItem.order_id].push(orderItem)

  pubsubClient.subscribe orderItemsChannel, processOrderItem
