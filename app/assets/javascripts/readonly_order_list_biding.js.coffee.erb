highlightedOrderLI = null

unhighlightOrder = (li) ->
  $(li).attr('style', '')

highlightOrderLI = (li) ->
  unhighlightOrder(highlightedOrderLI) if highlightedOrderLI
  $(li).attr('style', 'border: 2px solid yellow')
  highlightedOrderLI = li

ordersChannel = <%= Order.channel.to_json %>

pageVars = (role) ->
  window["$#{role}Vars"] ||= {}

viewerRole = (page) ->
  $(page).attr("data-viewer-role")

$(document).delegate '.navigator_page', "pagecreate", ->
  role = viewerRole(this)
  vars = pageVars(role)

  ordersUL = =>
    $(this).find('#orders')

  orderLI = (order)->
    ordersUL().find('[data-order-id=' + order.order_id + ']')

  focusedDate = $(this).attr('data-date')
  revenueSpan = $(this).find('.collected_revenue')

  for li in ordersUL().find('li[data-order-id]')
    $(li).formatListItem()

  revenue = (newRevenue) ->
    if typeof newRevenue == "number"
      revenueSpan.text(newRevenue.toString())
    else
      parseInt(revenueSpan.text())

  processOrder = (order) ->
    if order.created_on == focusedDate
      if order.deleted || !order.shown_to[role]
        orderLI(order).fadeOutAndRemove()
      else
        addOrUpdate(order)
        revenue(revenue() + order.revenue_increment)
        ordersUL().listview('refresh').trigger('create')
        highlightOrderLI orderLI(order)
        orderLI(order).formatListItem().blinkAndShow()

  addOrUpdate = (order) ->
    if order.paid
      $.toast order.order_name, I18n.t("states.paid")
    else
      if order.ready && !order.served
        $.toast order.order_name, I18n.t("states.ready")
    if (orderLI(order).exists())
      orderLI(order).replaceWith(orderTemplate.gsub order)
    else
      $(orderTemplate.gsub order).appendTo(ordersUL())

  if window.Faye && Faye.Client
    #reuse client to avoid memory leaks
    vars.pubSubClient ||= new Faye.Client(pubsubMountpoint)
    vars.pubSubClient.subscribe ordersChannel, (order) ->
      processOrder(order)
